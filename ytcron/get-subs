#!/bin/zsh

logfile="/var/log/ytcron.log"
base="/base"
arch="$base/.subs.archive"
conf="$base/.subs.conf"
lock="$base/.ytcron.pid"

echo "Sourcing $conf for configuration."
source $conf
echo "Configuration complete."

if [[ ! -d $base ]]; then
    echo "$0: base directory $base doesn't exist, bailing."
    exit -1
fi

if [[ -f $lock ]]; then
    echo "$0: lock $lock exists, bailing."
    exit -2
fi
print $$ > $lock

echo "Base directory exists; lockfile not present."
echo "Starting download of one-offs."

for vid in $vids; do
(
    print -- '================================================================================'
    print -- "===== $vid"
    print -- '================================================================================'
    youtube-dl -i \
        --output "$base/[queue]/%(title)s-%(id)s.%(ext)s" \
        --download-archive $arch \
        --reject-title $reject \
        --max-downloads $per \
        --playlist-end $max \
        --rate-limit $rate \
        --format $fmt \
        --all-subs \
        --write-thumbnail \
        $* $vid
    print -- '================================================================================'
    sleep 15
)
done >> $logfile

echo "Starting download of subscriptions."

for src in $subs; do
(
    print -- '================================================================================'
    print -- "===== $src"
    print -- '================================================================================'
    youtube-dl -i \
        --output "$base/%(uploader_id)s/%(title)s-%(id)s.%(ext)s" \
        --download-archive $arch \
        --reject-title $reject \
        --max-downloads $per \
        --playlist-end $max \
        --rate-limit $rate \
        --format $fmt \
        --all-subs \
        --write-thumbnail \
        $* $src
    print -- '================================================================================'
    sleep 15
)
done >> $logfile

rm $lock
