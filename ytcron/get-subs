#!/bin/zsh

base="/base"
arch="$base/.subs.archive"
conf="$base/.subs.conf"

source $conf

if [[ ! -d $base ]]; then
    echo "$0: base directory $base doesn't exist, bailing."
    exit -1
fi

LOCK="/var/lock/ytcron.pid"

if [[ -f $LOCK ]]; then
    echo "$0: lock $LOCK exists, bailing."
    exit -2
fi
touch $LOCK

for src in $subs; do
(
    print -- '================================================================================'
    print -- "===== $src"
    print -- '================================================================================'
    youtube-dl -i \
        --output "$base/%(uploader_id)s/%(title)s-%(id)s.%(ext)s" \
        --download-archive $arch \
        --reject-title $reject \
        --max-downloads $per \
        --playlist-end $max \
        --rate-limit $rate \
        --format $fmt \
        --all-subs \
        --write-thumbnail \
        $* $src
    print -- '================================================================================'
    sleep 15
)
done >> /var/log/ytcron.log

rm $LOCK
